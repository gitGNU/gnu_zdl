<!DOCTYPE html>
<html>
  <head>
    <!--
	ZigzagDownLoader (ZDL)
	
	This program is free software: you can redistribute it and/or modify it
	under the terms of the GNU General Public License as published
	by the Free Software Foundation; either version 3 of the License,
	or (at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
	or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program. If not, see http://www.gnu.org/licenses/.

	Copyright (C) 2011
	Gianluca Zoni <<zoninoz@inventati.org>>

	For information or to collaborate on the project:
	`https://savannah.nongnu.org/projects/zdl'
      -->

    <title>ZDL Lite Interface</title>
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet">
    <style>
        body {font-family:"Droid Sans", sans-serif; font-size:14px; background:#333; color:#eee;}
        table {border:1px solid #444; table-layout:fixed;}
        td {padding:5px; vertical-align:top; overflow:hidden; text-overflow:ellipsis; white-space: nowrap;}
        input {height:37px; background:#555; color:#ddd; font-size:13px; margin-right:4px; padding:0 5px; border:0;}
        button {min-width:110px; height:40px; background:#444; color:#fff; border:1px solid #333; padding:4px 3px;}
        button:hover {background:#000;}
        .new-link button:last-child {margin-left:3px;}
        .new-link input {width:calc(100% - 238px);}
        .commands button {margin-right:3px;}
        .commands input {width:110px;}
        .commands select {background:#555; color:#eee; width:calc(100% - 356px); margin:0 4px; padding:0 5px; border:none; height:38px; -webkit-appearance:none; -moz-appearance:none; appearance:none;}
        option {background:#444; color:#eee;}
        .header {height:20px; font-size:16px; font-weight:700; padding:0 5px;}
        .main {width:100%;}
        .info {color:#aaa;}
        .info span {color:#fff; margin-right:20px;}
        .downloads {height:160px; background:#000; color:#eee;}
        .downloads span {margin-right:5px;}
        .led {width:5px; background:#555;}
        .size {color:#888}
        .perc {color:#0c0;}
        .reddy {background:#f00!important;}
        .greeny {background:#0f0!important;}
        .console {width:100%; height:100px; background:#000; color:#ddd; padding:5px; font-size:12px; border:none; resize:none; overflow-y:hidden;}
    </style>
    <script src="api.js"></script>
</head>

<body>
<div class="header">ZDL Lite UI</div>
<table class="main">
    <tr>
        <td class="info">Downloader: <span id="downloader"></span>Path: <span id="path"></span>Player: <span id="player"></span></td>
    </tr>
    <tr>
        <td class="downloads" id="output"></td>
    </tr>
    <tr>
        <td class="new-link"><input type="text"><button id="add-link">Add link</button><button id="clean">Clean</button></td>
    </tr>
    <tr>
        <td class="commands"><input type="text"><button id="set-player">Set player</button><select class="select" id="selector"><option selected="selected" disabled>Select file ...</option></select><button id="play">Play</button></td>
    </tr>
    <tr>
        <td class="commands"><button id="change-ui">UI 1</button><button id="kill-all">Kill downloader</button><button id="exit-all">Close all</button></td>
    </tr>
    <tr>
        <td><textarea class="console" id="console"></textarea></td>
    </tr>
</table>

<script>
var _console = document.getElementById("console"),
    files = [];

function zdl_console(msg) {
    var lines = _console.value.split("\n");
    lines.length === 8 ? _console.value = msg : _console.value += msg;
}

function tryParse(str) {
    try {
        JSON.parse(str);
    } catch(e) {
        return false;
    }
    return true;
}

var options = {path: "__START_PATH__", file: "index.html"};
var myZDL = new ZDL(options);

function settingsFlow() {
    var arg = arguments[0] || false;
    myZDL.getStatus(arg).then(function(res) {
        if (tryParse(res)) {
            var obj = JSON.parse(res);
            document.getElementById("downloader").textContent = obj.downloader;
            document.getElementById("path").textContent = obj.path;
            document.getElementById("player").textContent = obj["conf"].player;
        }
        zdl_console("[ZDL] settings flow: get data\n");
        settingsFlow();
    }).catch(function(e) {
        zdl_console("[ZDL] settings flow: " + e + "\n");
    });
}

var output = document.getElementById("output"),
    selector = document.getElementById("selector");

function downloadsFlow() {
    var arg = arguments[0] || false;
    myZDL.getData(arg).then(function(res) {
        if (tryParse(res)) {
            var obj = JSON.parse(res), data = "";
            for (var key of obj) {
                if (parseInt(key.percent) < 100) {
                    data += "<span class='led greeny'>&nbsp;</span>";
                    zdl_console("[ZDL] downloads flow: " + parseFloat(key.speed).toFixed(2) + key.speed_measure + " " + key.eta + "\n");
                } else {
                    data += "<span class='led'>&nbsp;</span>";
                }
                data += "<span class='size'>"+(key.length / 1048576).toFixed(2)+"MB</span>";
                data += "<span class='perc'>" + key.percent + "%</span>";
                data += key.file + "<br>";
                output.innerHTML = data;
                if (files.indexOf(key.file) < 0) {
                    files.push(key.file);
                    var option = document.createElement("option");
                    option.text = key.file;
                    selector.add(option);
                }
            }
        }
        downloadsFlow();
    }).catch(function(e) {
        zdl_console("[ZDL] downloads flow: " + e + "\n");
    });
}

myZDL.initClient().then(function() {
    zdl_console("[ZDL] Flows initialized\n");
    settingsFlow(true);
    downloadsFlow(true);
});

document.querySelector(".main").addEventListener("click", function(event) {
    if (event.target.nodeName === "BUTTON") {
        switch (event.target.id) {
            case "add-link":
                output.innerHTML += "<span class='led reddy'>&nbsp;</span>starting download ... wait ...";
                var link = event.target.previousElementSibling;
                myZDL.addLink(link.value).then(function() {
                    zdl_console("[ZDL] downloads flow: added link " + link.value + "\n");
                    link.value = "";
                });
                break;
            case "clean":
                output.innerHTML = "";
                myZDL.cleanCompleted().then(function() {
                    zdl_console("[ZDL] downloads flow: removed data of completed downloads\n");
                });
                break;
            case "set-player":
                var input = event.target.previousElementSibling;
                myZDL.setGlobal("player", input.value).then(function() {
                    zdl_console("[ZDL] player: " + input.value + "\n");
                    input.value = "";
                });
                break;
            case "play":
                var file = event.target.previousElementSibling;
                myZDL.play(file.value).then(function() {
                    zdl_console("[ZDL] play file: " + file.value + "\n");
                });
                break;
            case "change-ui":
                zdl_console("[ZDL] change UI ...\n");
                myZDL.setGlobal("web_ui", "1").then(function() {
                    window.setTimeout(function() {
                        window.location.href = window.location.pathname;
                    }, 3000);
                });
                break;
            case "kill-all":
                myZDL.killAll().then(function() {
                    zdl_console("[ZDL] killall\n");
                });
                break;
            case "exit-all":
                zdl_console("[ZDL] server shutdown ...\n");
                myZDL.exitAll().then(function() {
                    window.setTimeout(function() {
                        window.location.href = window.location.pathname;
                    }, 3000);
                });
                break;
            default:
                return false;
        }
    }
}, false);
</script>
</body>
</html>
